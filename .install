#!/bin/bash

set -xe

transfer=1

## SETUP VIRETUALENV ##
virtualenv -p python3 ../tmp/venv
source ../tmp/venv/bin/activate
pip3 install -r <(grep -v tensorflow requirements.txt)
pip3 install tensorflow-gpu==1.12.0

## SETUP TASKCLUSTER ##
python3 util/taskcluster.py --arch gpu --target ../tmp/native_client
# Install ds_ctcdecoder package from TaskCluster
pip3 install $(python3 util/taskcluster.py --decoder)

if [ $transfer -eq 1 ]; then
    ## GET SOURCE CHECKPOINT ##
    SOURCE_MODEL='../keep/en-v030'
    mkdir $SOURCE_MODEL
    wget https://github.com/mozilla/DeepSpeech/releases/download/v0.3.0/deepspeech-0.3.0-checkpoint.tar.gz --directory-prefix="${SOURCE_MODEL}"
    tar xvzf ${SOURCE_MODEL}/deepspeech-0.3.0-checkpoint.tar.gz --directory "${SOURCE_MODEL}"
    rm ${SOURCE_MODEL}/deepspeech-0.3.0-checkpoint.tar.gz
fi

pushd ../keep/urbansound8k
unzip -o train.zip
pushd Train
for w in *.wav; do
    sox "$w" --compression 0.0 --no-dither -e signed -L -c 1 -b 16 -r 16k -t wav "conv_$w"
done
popd
popd

cp ../src/train_ds.csv ../keep/urbansound8k/Train
cp ../src/dev_ds.csv ../keep/urbansound8k/Train
